name: Build Firmware

on:
  push:
    branches:
      - main
      - develop
    tags:
      - 'v*.*.*'
  pull_request:
    branches:
      - main
      - develop
  workflow_dispatch: # Tillader manuel trigger

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üêç Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: üì¶ Install PlatformIO
        run: |
          python -m pip install --upgrade pip
          pip install platformio

      - name: üîß Create Credentials.h from template
        run: |
          if [ ! -f "src/config/Credentials.h" ]; then
            echo "Creating Credentials.h from template..."
            cp src/config/Credentials.h.example src/config/Credentials.h
            # For CI build, brug dummy credentials
            sed -i 's/YourWiFiSSID/CI_BUILD_SSID/g' src/config/Credentials.h
            sed -i 's/YourWiFiPassword/CI_BUILD_PASSWORD/g' src/config/Credentials.h
          fi

      - name: üèóÔ∏è Build firmware
        run: |
          pio run -e esp32dev

      - name: üìù Get build info
        id: build_info
        run: |
          echo "date=$(date +'%Y-%m-%d')" >> $GITHUB_OUTPUT
          echo "sha_short=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
          if [[ $GITHUB_REF == refs/tags/* ]]; then
            echo "version=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          else
            echo "version=dev-$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
          fi

      - name: üì¶ Rename firmware with version
        run: |
          cp .pio/build/esp32dev/firmware.bin \
             RobotMower-${{ steps.build_info.outputs.version }}.bin

      - name: üì§ Upload firmware artifact
        uses: actions/upload-artifact@v4
        with:
          name: firmware-${{ steps.build_info.outputs.version }}
          path: |
            RobotMower-*.bin
            .pio/build/esp32dev/*.elf
          retention-days: 90

      - name: üìä Build summary
        run: |
          echo "### üéâ Build Success!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** ${{ steps.build_info.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "**Date:** ${{ steps.build_info.outputs.date }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ steps.build_info.outputs.sha_short }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Firmware file:** RobotMower-${{ steps.build_info.outputs.version }}.bin" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          ls -lh RobotMower-*.bin >> $GITHUB_STEP_SUMMARY

  release:
    needs: build
    if: github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/v')
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üì¶ Download firmware artifact
        uses: actions/download-artifact@v4
        with:
          pattern: firmware-*
          merge-multiple: true

      - name: üìù Generate release notes
        id: release_notes
        run: |
          if [[ $GITHUB_REF == refs/tags/* ]]; then
            VERSION=${GITHUB_REF#refs/tags/}
            IS_PRERELEASE=false
            RELEASE_NAME="Robot Mower $VERSION"
          else
            VERSION="latest"
            IS_PRERELEASE=true
            RELEASE_NAME="Robot Mower Latest (Development)"
          fi

          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "is_prerelease=$IS_PRERELEASE" >> $GITHUB_OUTPUT
          echo "release_name=$RELEASE_NAME" >> $GITHUB_OUTPUT

          # Opret release notes
          cat << EOF > RELEASE_NOTES.md
          # Robot Mower Firmware $VERSION

          ## üöÄ Installation

          ### Via Web Interface (Anbefalet)
          1. √Öbn http://robot-mower.local/update i browser
          2. Upload \`RobotMower-*.bin\` filen
          3. Vent p√• genstart

          ### Via Arduino IDE
          1. Download \`RobotMower-*.bin\`
          2. Tools ‚Üí ESP32 Sketch Data Upload

          ### Via PlatformIO
          \`\`\`bash
          pio run -e esp32dev-ota --target upload
          \`\`\`

          ## ‚öôÔ∏è Konfiguration

          **VIGTIGT:** F√∏r f√∏rste brug, opdater:
          - WiFi credentials i \`src/config/Credentials.h\`
          - OTA password i \`src/config/Config.h\`

          ## üìã Changelog

          Se commit historik for detaljer:
          https://github.com/${{ github.repository }}/commits/${{ github.sha }}

          ## üêõ Bug Reports

          Rapporter problemer p√•: https://github.com/${{ github.repository }}/issues
          EOF

      - name: üéâ Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          name: ${{ steps.release_notes.outputs.release_name }}
          tag_name: ${{ steps.release_notes.outputs.version }}
          body_path: RELEASE_NOTES.md
          files: |
            RobotMower-*.bin
          draft: false
          prerelease: ${{ steps.release_notes.outputs.is_prerelease }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
